<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - LofStore</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Raleway", sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #b52d1e 0%, #d63a2b 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .cadastro-container {
            background: white;
            width: 100%;
            max-width: 500px;
            padding: 40px;
            border-radius: 20px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: #b52d1e;
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .logo p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #b52d1e;
        }
        
        .form-group input {
            border: none;
            outline: none;
            background: none;
            padding: 12px 0;
            font-size: 16px;
            width: 100%;
            color: #333;
        }
        
        .form-group input::placeholder {
            color: #999;
        }

        /* Validação visual */
        input:invalid:not(:placeholder-shown) {
            color: #f44336;
        }

        input:valid:not(:placeholder-shown) {
            color: #4CAF50;
        }
        
        .btn-cadastrar {
            width: 100%;
            background-color: #b52d1e;
            color: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            border-radius: 30px;
            height: 50px;
        }
        
        .btn-cadastrar:hover {
            background-color: #9d2619;
        }
        
        .btn-cadastrar:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }
        
        .footer a {
            color: #b52d1e;
            text-decoration: none;
            font-weight: 600;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #b52d1e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .senha-requisitos {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            padding-left: 5px;
        }

        .senha-requisitos.valido {
            color: #155724;
        }

        .senha-requisitos.invalido {
            color: #721c24;
        }

        /* Mensagem de privacidade */
        .mensagem-privacidade {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 13px;
            color: #1976D2;
        }

        .mensagem-privacidade strong {
            font-weight: 600;
        }

        /* Força da senha */
        .senha-forca {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .senha-forca-barra {
            height: 100%;
            width: 0%;
            transition: all 0.3s;
        }

        .senha-forca-barra.fraca {
            width: 33%;
            background: #f44336;
        }

        .senha-forca-barra.media {
            width: 66%;
            background: #FF9800;
        }

        .senha-forca-barra.forte {
            width: 100%;
            background: #4CAF50;
        }

        small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="cadastro-container">
        <div class="logo">
            <h1>Criar Conta</h1>
            <p>Cadastre-se na LofStore</p>
        </div>
        
        <div id="message" class="message"></div>
        
        <form id="form-cadastro">
            <div class="form-group">
                <label for="nome">Nome Completo *</label>
                <input type="text" 
                       id="nome" 
                       required 
                       minlength="2"
                       maxlength="100"
                       pattern="[A-Za-zÀ-ÿ\s]+"
                       title="Digite seu nome completo (apenas letras)"
                       placeholder="João Silva"
                       autocomplete="name">
                <small>Apenas letras e espaços</small>
            </div>

            <div class="form-group">
                <label for="telefone">Telefone *</label>
                <input type="tel" 
                       id="telefone" 
                       required 
                       minlength="14"
                       maxlength="15"
                       placeholder="(00) 00000-0000"
                       title="Digite seu telefone com DDD"
                       autocomplete="tel">
                <small>Com DDD</small>
            </div>

            <div class="form-group">
                <label for="endereco">Endereço Completo *</label>
                <input type="text" 
                       id="endereco" 
                       required 
                       minlength="10"
                       maxlength="500"
                       placeholder="Rua, número, bairro, cidade, estado"
                       title="Digite seu endereço completo"
                       autocomplete="street-address">
                <small>Mínimo 10 caracteres</small>
            </div>
            
            <div class="form-group">
                <label for="email">E-mail *</label>
                <input type="email" 
                       id="email" 
                       required 
                       maxlength="100"
                       pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                       placeholder="seu@email.com"
                       title="Digite um e-mail válido"
                       autocomplete="email">
                <small>Use um e-mail válido</small>
            </div>
            
            <div class="form-group">
                <label for="senha">Senha *</label>
                <input type="password" 
                       id="senha" 
                       required 
                       minlength="6"
                       maxlength="50"
                       placeholder="Mínimo 6 caracteres"
                       title="Mínimo 6 caracteres"
                       autocomplete="new-password">
                <div class="senha-forca">
                    <div class="senha-forca-barra" id="senha-forca-barra"></div>
                </div>
                <div id="senha-requisitos" class="senha-requisitos">
                    Mínimo 6 caracteres
                </div>
            </div>
            
            <div class="form-group">
                <label for="confirmar-senha">Confirmar Senha *</label>
                <input type="password" 
                       id="confirmar-senha" 
                       required 
                       minlength="6"
                       maxlength="50"
                       placeholder="Digite a senha novamente"
                       title="As senhas devem ser iguais"
                       autocomplete="new-password">
            </div>

            <!-- MENSAGEM DE PRIVACIDADE -->
            <div class="mensagem-privacidade">
                <p style="margin: 0;">
                     <strong>Privacidade:</strong> Seus dados são usados apenas para criar sua conta e processar pedidos. 
                    Não compartilhamos suas informações com terceiros.
                </p>
            </div>
            
            <button type="submit" id="btn-cadastrar" class="btn-cadastrar">
                <span id="btn-texto">Criar Conta</span>
            </button>

            <small style="text-align: center; margin-top: 15px;">* Campos obrigatórios</small>
        </form>
        
        <div class="footer">
            <p>Já tem uma conta? <a href="login-usuario.html">Faça login</a></p>
            <p><a href="index.html">Voltar para a loja</a></p>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { 
            createUserWithEmailAndPassword,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            doc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const form = document.getElementById('form-cadastro');
        const messageEl = document.getElementById('message');
        const btnCadastrar = document.getElementById('btn-cadastrar');
        const btnTexto = document.getElementById('btn-texto');

        // =================== VALIDAÇÕES EM TEMPO REAL ===================

        // Validação de senha em tempo real
        const senhaInput = document.getElementById('senha');
        const senhaRequisitos = document.getElementById('senha-requisitos');
        const senhaForcaBarra = document.getElementById('senha-forca-barra');

        senhaInput.addEventListener('input', function() {
            const senha = this.value;
            const tamanho = senha.length;
            
            // Calcula força da senha
            let forca = 0;
            if (tamanho >= 6) forca++;
            if (tamanho >= 8) forca++;
            if (/[A-Z]/.test(senha)) forca++;
            if (/[0-9]/.test(senha)) forca++;
            if (/[^A-Za-z0-9]/.test(senha)) forca++;
            
            // Atualiza barra de força
            senhaForcaBarra.className = 'senha-forca-barra';
            if (forca <= 2) {
                senhaForcaBarra.classList.add('fraca');
            } else if (forca <= 3) {
                senhaForcaBarra.classList.add('media');
            } else {
                senhaForcaBarra.classList.add('forte');
            }
            
            // Atualiza mensagem
            if (tamanho < 6) {
                senhaRequisitos.textContent = `Faltam ${6 - tamanho} caracteres`;
                senhaRequisitos.className = 'senha-requisitos invalido';
            } else {
                senhaRequisitos.textContent = forca <= 2 ? 'Senha fraca' : forca <= 3 ? 'Senha média' : 'Senha forte';
                senhaRequisitos.className = 'senha-requisitos valido';
            }
        });

        // Máscara de telefone
        const telefoneInput = document.getElementById('telefone');
        telefoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
                value = value.replace(/(\d)(\d{4})$/, '$1-$2');
            }
            e.target.value = value;
        });

        // Validação de nome (apenas letras)
        const nomeInput = document.getElementById('nome');
        nomeInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^A-Za-zÀ-ÿ\s]/g, '');
        });

        // =================== FUNÇÕES AUXILIARES ===================

        function showMessage(text, type = 'info') {
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            if (type !== 'info') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }
        }

        function showLoading(isLoading) {
            if (isLoading) {
                btnTexto.innerHTML = `<div class="loading"></div> Criando conta...`;
                btnCadastrar.disabled = true;
            } else {
                btnCadastrar.disabled = false;
                btnTexto.textContent = 'Criar Conta';
            }
        }

        // =================== VALIDAÇÃO COMPLETA DO FORMULÁRIO ===================

        function validarFormulario() {
            const nome = document.getElementById('nome').value.trim();
            const telefone = document.getElementById('telefone').value.trim();
            const endereco = document.getElementById('endereco').value.trim();
            const email = document.getElementById('email').value.trim();
            const senha = document.getElementById('senha').value;
            const confirmarSenha = document.getElementById('confirmar-senha').value;

            // Valida nome
            if (nome.length < 2 || nome.length > 100) {
                return { valido: false, mensagem: 'Nome deve ter entre 2 e 100 caracteres' };
            }
            if (!/^[A-Za-zÀ-ÿ\s]+$/.test(nome)) {
                return { valido: false, mensagem: 'Nome deve conter apenas letras' };
            }

            // Valida telefone
            const telefoneLimpo = telefone.replace(/\D/g, '');
            if (telefoneLimpo.length < 10 || telefoneLimpo.length > 11) {
                return { valido: false, mensagem: 'Telefone inválido (use DDD + número)' };
            }

            // Valida endereço
            if (endereco.length < 10 || endereco.length > 500) {
                return { valido: false, mensagem: 'Endereço deve ter entre 10 e 500 caracteres' };
            }

            // Valida email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return { valido: false, mensagem: 'E-mail inválido' };
            }

            // Valida senha
            if (senha.length < 6 || senha.length > 50) {
                return { valido: false, mensagem: 'Senha deve ter entre 6 e 50 caracteres' };
            }

            // Valida confirmação de senha
            if (senha !== confirmarSenha) {
                return { valido: false, mensagem: 'As senhas não coincidem' };
            }

            return { valido: true };
        }

        // =================== SUBMISSÃO DO FORMULÁRIO ===================

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Valida formulário
            const validacao = validarFormulario();
            if (!validacao.valido) {
                showMessage(validacao.mensagem, 'error');
                return;
            }

            const nome = document.getElementById('nome').value.trim();
            const telefone = document.getElementById('telefone').value.trim();
            const endereco = document.getElementById('endereco').value.trim();
            const email = document.getElementById('email').value.trim();
            const senha = document.getElementById('senha').value;

            showLoading(true);
            showMessage('Criando sua conta...', 'info');

            try {
                // Cria usuário no Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
                const user = userCredential.user;

                // Atualiza o perfil com o nome
                await updateProfile(user, {
                    displayName: nome
                });

                // Salva dados adicionais no Firestore
                await setDoc(doc(db, "usuarios", user.uid), {
                    nome: nome,
                    email: email,
                    telefone: telefone,
                    endereco: endereco,
                    criadoEm: new Date().toISOString(),
                    tipo: 'cliente'
                });

                showMessage('Conta criada com sucesso! Redirecionando...', 'success');

                // Redireciona após 2 segundos
                setTimeout(() => {
                    window.location.href = 'perfil.html';
                }, 2000);

            } catch (error) {
                console.error('Erro ao criar conta:', error);
                showLoading(false);

                if (error.code === 'auth/email-already-in-use') {
                    showMessage('Este e-mail já está em uso', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showMessage('E-mail inválido', 'error');
                } else if (error.code === 'auth/weak-password') {
                    showMessage('Senha muito fraca', 'error');
                } else if (error.code === 'auth/operation-not-allowed') {
                    showMessage('Cadastro desabilitado temporariamente', 'error');
                } else {
                    showMessage('Erro ao criar conta: ' + error.message, 'error');
                }
            }
        });
    </script>
</body>
</html>